machine:
  services:
    - docker

dependencies:
  override:
    - docker build -t gliderlabs/pagebuilder .

test:
  override:
    - /bin/true

deployment:
  master:
    branch: master
    commands:
      - |
        docker run \
          -v /home/ubuntu/.ssh:/tmp/ssh \
          -v $PWD:/project \
          -e LATEST=master \
          gliderlabs/pagebuilder \
            deploy "build $CIRCLE_BUILD_NUM"
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push gliderlabs/pagebuilder
      - git push origin master:mirror
  mirror:
    branch: mirror
    commands:
      - |
        docker run \
          -v /home/ubuntu/.ssh:/tmp/ssh \
          -v $PWD:/project \
          gliderlabs/pagebuilder \
            deploy "build $CIRCLE_BUILD_NUM"
