machine:
  services:
    - docker

dependencies:
  override:
    - docker build -t gliderlabs/pagebuilder .

test:
  override:
    - docker run -v $PWD:/project gliderlabs/pagebuilder mkdocs build

deployment:
  docs:
    branch: [master, mirror]
    commands:
      - |
        docker run \
          -v /home/ubuntu/.ssh:/tmp/ssh \
          -v $PWD:/project \
          -e LATEST=master \
          gliderlabs/pagebuilder \
            deploy "build $CIRCLE_BUILD_NUM"
  mirror:
    branch: master
    commands:
      - git push origin master:mirror
  docker:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push gliderlabs/pagebuilder
