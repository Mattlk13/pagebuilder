#!/bin/bash
set -ex

branch="$(git rev-parse --abbrev-ref HEAD)"
latest="${LATEST:-release}"
tag="$TAG"

mkdocs build
cp -r site /tmp/site

if [[ -d /tmp/ssh ]]; then
  rm -rf /root/.ssh
  cp -r /tmp/ssh /root/.ssh
  chown -R root /root/.ssh
fi

if ! git fetch --depth=1 origin gh-pages; then
  git checkout --orphan gh-pages
  git rm --cached -r .
else
  git checkout --track origin/gh-pages
fi

rm -rf "$branch"
mv /tmp/site "$branch"
git add "$branch"
if [[ "$branch" == "$latest" ]]; then
  rm -rf latest
  cp -r "$branch" latest
  git add latest
fi
if [[ "$tag" ]]; then
  rm -rf "$tag"
  cp -r "$branch" "$tag"
  git add "$tag"
fi
git commit -m "$1"
git push origin gh-pages:gh-pages
